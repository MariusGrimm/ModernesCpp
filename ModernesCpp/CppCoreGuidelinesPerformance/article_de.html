<div class="vorspann"><img class="rteInlinetag" src="https://heise-cms.de/thumbs//TN_150613462_262829c53b.png" title="<ir_inline itemname=bilder_mvp_bild_var2:1 type=2>" style="max-height: 25px; max-width: 25px;"></div><div class="vorspann">Bevor ich über die Regeln zur Performanz schreibe, muss ich erst eine einfache Aufgabe erledigen: auf die Elemente eines Containers sukzessive zugreifen.</div><div class="text">Dies ist die letzte Regel zur Arithmetik.</div><div class="text"><b><a href="http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Res-subscripts" alt="%7B%22user_params%22%3A%22%22%2C%22destination%22%3A%22http%3A%2F%2Fisocpp.github.io%2FCppCoreGuidelines%2FCppCoreGuidelines%23Res-subscripts%22%2C%22custom%22%3A%7B%7D%2C%22subject%22%3A%22%22%2C%22alias%22%3A%22%22%2C%22version%22%3A1%2C%22href%22%3A%22http%3A%2F%2Fisocpp.github.io%2FCppCoreGuidelines%2FCppCoreGuidelines%23Res-subscripts%22%2C%22anchor%22%3A%22%22%2C%22target%22%3A%22_blank%22%2C%22text%22%3A%22ES.107%3A%20Don%C2%92t%20use%20unsigned%20for%20subscripts%2C%20prefer%20gsl%3A%3Aindex%26nbsp%3B%22%2C%22type%22%3A%22E%22%2C%22ir_link%22%3A1%7D" title="Link auf http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Res-subscripts">ES.107: Don’t use unsigned for subscripts, prefer gsl::index&nbsp;</a></b></div><div class="text">Habe ich gesagt, dass das eine einfache Aufgabe wird? Das war eine Lüge! Viel kann schiefgehen. Hier ist ein Beispiel mit einem <i>std::vector</i>:<br></div><div class="pre">vector&lt;int&gt; vec = /*...*/;<br><br>for (int i = 0; i &lt; vec.size(); i += 2)&nbsp;&nbsp;&nbsp;&nbsp; // may not be big enough (2)<br>&nbsp;&nbsp;&nbsp; cout &lt;&lt; vec[i] &lt;&lt; '\n';<br>for (unsigned i = 0; i &lt; vec.size(); i += 2)&nbsp; // risk wraparound&nbsp;&nbsp;&nbsp;&nbsp; (3)<br>&nbsp;&nbsp;&nbsp; cout &lt;&lt; vec[i] &lt;&lt; '\n';<br>for (auto i = 0; i &lt; vec.size(); i += 2)&nbsp;&nbsp;&nbsp; // may not be big enough (2)<br>&nbsp;&nbsp;&nbsp; cout &lt;&lt; vec[i] &lt;&lt; '\n';<br>for (vector&lt;int&gt;::size_type i = 0; i &lt; vec.size(); i += 2)// verbose (1)<br>&nbsp;&nbsp;&nbsp; cout &lt;&lt; vec[i] &lt;&lt; '\n';<br>for (auto i = vec.size()-1; i &gt;= 0; i -= 2)&nbsp;&nbsp;&nbsp; // bug&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (4) <br>&nbsp;&nbsp;&nbsp; cout &lt;&lt; vec[i] &lt;&lt; '\n';<br>for (int i = vec.size()-1; i &gt;= 0; i -= 2)&nbsp; // may not be big enough (2)<br>&nbsp;&nbsp;&nbsp; cout &lt;&lt; vec[i] &lt;&lt; '\n';</div><div class="text">Verängstigt? Verständlich! Lediglich die Zeile (1) ist korrekt. In den Zeilen (2)&nbsp; kann es passieren, dass die Variable <i>i</i> zu klein ist. Der Effekt ist dann gegebenenfalls ein Überlauf. Das gilt nicht für die Zeile (3), denn <i>i</i> ist vorzeichenlos. In diesem Fall winkt eine Modulo-Operation. Ich schrieb bereits in meinem letzten Artikel über dieses Phänomen: "<a alt="%7B%22type%22%3A%22B%22%2C%22ir_link%22%3A1%2C%22target%22%3A%22%22%2C%22text%22%3A%22C%2B%2B%20Core%20Guidelines%3A%20Regeln%20zu%20Anweisungen%20und%20zur%20Arithmetik%22%2C%22anchor%22%3A%22%22%2C%22version%22%3A1%2C%22custom%22%3A%7B%7D%2C%22alias%22%3A%22%22%2C%22subject%22%3A%22%22%2C%22href%22%3A%22%2Fexec%2Fmainmenu.pl%3Fsid%3D6da5db36567ecb6291ebc84cf1223e6d%26rm%3Dopen_article_id%26bid%3D2390916%22%2C%22user_params%22%3A%22%22%2C%22destination%22%3A2390916%7D" href="/exec/mainmenu.pl?sid=6da5db36567ecb6291ebc84cf1223e6d&amp;rm=open_article_id&amp;bid=2390916" title="Link auf Beitrag 2390916">C++ Core Guidelines: Regeln zu Anweisungen und zur Arithmetik</a>". Um genau zu sein, war es die Regel ES.106. </div><div class="text">Damit bleibt noch die Zeile 4 übrig. Sie ist mein eindeutiger Favorit. Was ist das Problem? <i>vec.size() </i>vom Typ <i>std::size_t</i> ist. std::size_t ist ein vorzeichenloser Typ und kann daher keine negativen Zahlen repräsentieren. Überlege nun, was passieren soll, wenn der Vektor leer ist. Das bedeutet, dass <i>vec.size() - 1</i> genau <i>-1 </i>ist. Damit erhalten wir den maximalen Wert für <i>std::size_t</i>. </div><div class="text">Das Programm<i> index.cpp </i>zeigt dieses besondere Verhalten: </div><div class="pre">// index.cpp<br><br>#include &lt;iostream&gt;<br>#include &lt;vector&gt;<br><br>int main(){<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; std::cout &lt;&lt; std::endl;<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; std::vector&lt;int&gt; vec{};<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; auto ind1 = vec.size() - 1 ;<br>&nbsp;&nbsp;&nbsp; int ind2 = vec.size() -1 ;<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; std::cout &lt;&lt; "ind1: " &lt;&lt; ind1 &lt;&lt; std::endl;<br>&nbsp;&nbsp;&nbsp; std::cout &lt;&lt; "ind2: " &lt;&lt; ind2 &lt;&lt; std::endl;<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; std::cout &lt;&lt; std::endl;<br>&nbsp;&nbsp;&nbsp; <br>}</div><div class="text">Hier folgt auch schon die Ausgabe des Programms.</div><div class="text"><img class="rteInlinetag" src="https://heise-cms.de/thumbs//TN_150613466_858045e576.png" title="<ir_inline itemname=bilder_mvp_bild_var2:2 type=2>" style="max-height: 25px; max-width: 25px;"></div><div class="text">Die Guidelines schlagen vor, dass die Variable <i>i</i> den Typ <i>gsl::index</i> besitzen soll:</div><div class="pre">for (gsl::index i = 0; i &lt; vec.size(); i += 2)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // ok<br>&nbsp;&nbsp;&nbsp; cout &lt;&lt; vec[i] &lt;&lt; '\n';<br>for (gsl::index i = vec.size()-1; i &gt;= 0; i -= 2)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // ok<br>&nbsp;&nbsp;&nbsp; cout &lt;&lt; vec[i] &lt;&lt; '\n';</div><div class="text">Falls das keine Option ist, verwende den Typ <i>std::vector&lt;int&gt;::size_type</i> für <i>i</i>.</div><div class="text">Performanz ist die Domäne von C++! Ich denke, dass ist ein Glaubenssatz in der C++-Community. Daher war ich gespannt darauf, über die Regeln zur Performanz schreiben zu dürfen. Aber das ist kaum möglich, da die bestehenden Regeln sehr wenig Substanz besitzen. Meist bestehen sie nur aus dem Titel und einer Begründung. Dazu fehlt häufig auch die Begründung.</div><div class="text">Da muss ich durch. Hier sind die ersten Regeln:</div><div class="text"><ul><li> <a alt="%7B%22type%22%3A%22E%22%2C%22ir_link%22%3A1%2C%22anchor%22%3A%22%22%2C%22target%22%3A%22_blank%22%2C%22text%22%3A%22Per.1%3A%20Don%C2%92t%20optimize%20without%20reason%22%2C%22subject%22%3A%22%22%2C%22custom%22%3A%7B%7D%2C%22alias%22%3A%22%22%2C%22version%22%3A1%2C%22href%22%3A%22http%3A%2F%2Fisocpp.github.io%2FCppCoreGuidelines%2FCppCoreGuidelines%23Rper-reason%22%2C%22user_params%22%3A%22%22%2C%22destination%22%3A%22http%3A%2F%2Fisocpp.github.io%2FCppCoreGuidelines%2FCppCoreGuidelines%23Rper-reason%22%7D" href="http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rper-reason" title="Link auf http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rper-reason">Per.1: Don’t optimize without reason</a> </li><li> <a href="http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rper-Knuth" alt="%7B%22version%22%3A1%2C%22custom%22%3A%7B%7D%2C%22alias%22%3A%22%22%2C%22subject%22%3A%22%22%2C%22href%22%3A%22http%3A%2F%2Fisocpp.github.io%2FCppCoreGuidelines%2FCppCoreGuidelines%23Rper-Knuth%22%2C%22user_params%22%3A%22%22%2C%22destination%22%3A%22http%3A%2F%2Fisocpp.github.io%2FCppCoreGuidelines%2FCppCoreGuidelines%23Rper-Knuth%22%2C%22type%22%3A%22E%22%2C%22ir_link%22%3A1%2C%22target%22%3A%22_blank%22%2C%22text%22%3A%22Per.2%3A%20Don%C2%92t%20optimize%20prematurely%22%2C%22anchor%22%3A%22%22%7D" title="Link auf http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rper-Knuth">Per.2: Don’t optimize prematurely</a> </li><li> <a alt="%7B%22href%22%3A%22http%3A%2F%2Fisocpp.github.io%2FCppCoreGuidelines%2FCppCoreGuidelines%23Rper-critical%22%2C%22custom%22%3A%7B%7D%2C%22alias%22%3A%22%22%2C%22subject%22%3A%22%22%2C%22version%22%3A1%2C%22destination%22%3A%22http%3A%2F%2Fisocpp.github.io%2FCppCoreGuidelines%2FCppCoreGuidelines%23Rper-critical%22%2C%22user_params%22%3A%22%22%2C%22ir_link%22%3A1%2C%22type%22%3A%22E%22%2C%22anchor%22%3A%22%22%2C%22target%22%3A%22_blank%22%2C%22text%22%3A%22Per.3%3A%20Don%C2%92t%20optimize%20something%20that%C2%92s%20not%20performance%20critical%22%7D" href="http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rper-critical" title="Link auf http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rper-critical">Per.3: Don’t optimize something that’s not performance critical</a> </li><li> <a title="Link auf http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rper-simple" href="http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rper-simple" alt="%7B%22type%22%3A%22E%22%2C%22ir_link%22%3A1%2C%22target%22%3A%22_blank%22%2C%22text%22%3A%22Per.4%3A%20Don%C2%92t%20assume%20that%20complicated%20code%20is%20necessarily%20faster%20than%20simple%20code%22%2C%22anchor%22%3A%22%22%2C%22version%22%3A1%2C%22subject%22%3A%22%22%2C%22custom%22%3A%7B%7D%2C%22alias%22%3A%22%22%2C%22href%22%3A%22http%3A%2F%2Fisocpp.github.io%2FCppCoreGuidelines%2FCppCoreGuidelines%23Rper-simple%22%2C%22user_params%22%3A%22%22%2C%22destination%22%3A%22http%3A%2F%2Fisocpp.github.io%2FCppCoreGuidelines%2FCppCoreGuidelines%23Rper-simple%22%7D">Per.4: Don’t assume that complicated code is necessarily faster than simple code</a> </li><li> <a href="http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rper-low" alt="%7B%22custom%22%3A%7B%7D%2C%22alias%22%3A%22%22%2C%22subject%22%3A%22%22%2C%22version%22%3A1%2C%22href%22%3A%22http%3A%2F%2Fisocpp.github.io%2FCppCoreGuidelines%2FCppCoreGuidelines%23Rper-low%22%2C%22user_params%22%3A%22%22%2C%22destination%22%3A%22http%3A%2F%2Fisocpp.github.io%2FCppCoreGuidelines%2FCppCoreGuidelines%23Rper-low%22%2C%22type%22%3A%22E%22%2C%22ir_link%22%3A1%2C%22anchor%22%3A%22%22%2C%22target%22%3A%22_blank%22%2C%22text%22%3A%22Per.5%3A%20Don%C2%92t%20assume%20that%20low-level%20code%20is%20necessarily%20faster%20than%20high-level%20code%22%7D" title="Link auf http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rper-low">Per.5: Don’t assume that low-level code is necessarily faster than high-level code</a> </li><li> <a href="http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rper-measure" alt="%7B%22type%22%3A%22E%22%2C%22ir_link%22%3A1%2C%22anchor%22%3A%22%22%2C%22text%22%3A%22Per.6%3A%20Don%C2%92t%20make%20claims%20about%20performance%20without%20measurements%22%2C%22target%22%3A%22_blank%22%2C%22subject%22%3A%22%22%2C%22alias%22%3A%22%22%2C%22custom%22%3A%7B%7D%2C%22version%22%3A1%2C%22href%22%3A%22http%3A%2F%2Fisocpp.github.io%2FCppCoreGuidelines%2FCppCoreGuidelines%23Rper-measure%22%2C%22user_params%22%3A%22%22%2C%22destination%22%3A%22http%3A%2F%2Fisocpp.github.io%2FCppCoreGuidelines%2FCppCoreGuidelines%23Rper-measure%22%7D" title="Link auf http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rper-measure">Per.6: Don’t make claims about performance without measurements</a> </li></ul></div><div class="text">Anstelle jetzt allgemeine Sätze zu Gemeinplätzen von mir zu geben, werde ich ein paar Beispiele für die Regeln präsentieren. Los geht es mit den Regeln Per.4, Per.5 und P.6:</div><div class="text"><b><a href="http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rper-simple" alt="%7B%22href%22%3A%22http%3A%2F%2Fisocpp.github.io%2FCppCoreGuidelines%2FCppCoreGuidelines%23Rper-simple%22%2C%22version%22%3A1%2C%22custom%22%3A%7B%7D%2C%22subject%22%3A%22%22%2C%22alias%22%3A%22%22%2C%22destination%22%3A%22http%3A%2F%2Fisocpp.github.io%2FCppCoreGuidelines%2FCppCoreGuidelines%23Rper-simple%22%2C%22user_params%22%3A%22%22%2C%22ir_link%22%3A1%2C%22type%22%3A%22E%22%2C%22target%22%3A%22_blank%22%2C%22text%22%3A%22Per.4%3A%20Don%C2%92t%20assume%20that%20complicated%20code%20is%20necessarily%20faster%20than%20simple%20code%22%2C%22anchor%22%3A%22%22%7D" title="Link auf http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rper-simple">Per.4: Don’t assume that complicated code is necessarily faster than simple code</a> <br></b> </div><div class="text"><b><a title="Link auf http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rper-low" href="http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rper-low" alt="%7B%22destination%22%3A%22http%3A%2F%2Fisocpp.github.io%2FCppCoreGuidelines%2FCppCoreGuidelines%23Rper-low%22%2C%22user_params%22%3A%22%22%2C%22href%22%3A%22http%3A%2F%2Fisocpp.github.io%2FCppCoreGuidelines%2FCppCoreGuidelines%23Rper-low%22%2C%22custom%22%3A%7B%7D%2C%22alias%22%3A%22%22%2C%22subject%22%3A%22%22%2C%22version%22%3A1%2C%22anchor%22%3A%22%22%2C%22target%22%3A%22_blank%22%2C%22text%22%3A%22Per.5%3A%20Don%C2%92t%20assume%20that%20low-level%20code%20is%20necessarily%20faster%20than%20high-level%20code%22%2C%22ir_link%22%3A1%2C%22type%22%3A%22E%22%7D">Per.5: Don’t assume that low-level code is necessarily faster than high-level code</a> <br></b> </div><div class="text"><b><a href="http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rper-measure" alt="%7B%22anchor%22%3A%22%22%2C%22target%22%3A%22_blank%22%2C%22text%22%3A%22Per.6%3A%20Don%C2%92t%20make%20claims%20about%20performance%20without%20measurements%22%2C%22type%22%3A%22E%22%2C%22ir_link%22%3A1%2C%22user_params%22%3A%22%22%2C%22destination%22%3A%22http%3A%2F%2Fisocpp.github.io%2FCppCoreGuidelines%2FCppCoreGuidelines%23Rper-measure%22%2C%22subject%22%3A%22%22%2C%22custom%22%3A%7B%7D%2C%22alias%22%3A%22%22%2C%22version%22%3A1%2C%22href%22%3A%22http%3A%2F%2Fisocpp.github.io%2FCppCoreGuidelines%2FCppCoreGuidelines%23Rper-measure%22%7D" title="Link auf http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rper-measure">Per.6: Don’t make claims about performance without measurements</a></b></div><div class="text">Bevor ich meinen Artikel fortsetze, muss ich mich zuerst absichern. Ich empfehle, nicht das Singleton Pattern verwenden. Ich will nur darlegen, dass anspruchsvoller und Low-level-Code sich nicht immer auszahlt. Um meine Aussage zu belegen, werde ich natürlich die Performanz messen.</div><div class="text">Lang, lang ist es her, da schrieb ich einen Artikel zur thread-sicheren Initialisierung des Singleton Pattern: "<a href="https://www.grimm-jaud.de/index.php/blog/threadsicheres-initialisieren-eines-singletons" alt="%7B%22user_params%22%3A%22%22%2C%22destination%22%3A%22https%3A%2F%2Fwww.grimm-jaud.de%2Findex.php%2Fblog%2Fthreadsicheres-initialisieren-eines-singletons%22%2C%22alias%22%3A%22%22%2C%22custom%22%3A%7B%7D%2C%22subject%22%3A%22%22%2C%22version%22%3A1%2C%22href%22%3A%22https%3A%2F%2Fwww.grimm-jaud.de%2Findex.php%2Fblog%2Fthreadsicheres-initialisieren-eines-singletons%22%2C%22anchor%22%3A%22%22%2C%22target%22%3A%22_blank%22%2C%22text%22%3A%22Thread%20sicheres%20Initialisieren%20eines%20Singleton%22%2C%22type%22%3A%22E%22%2C%22ir_link%22%3A1%7D" title="Link auf https://www.grimm-jaud.de/index.php/blog/threadsicheres-initialisieren-eines-singletons">Thread sicheres Initialisieren eines Singleton</a>". Die zentrale Idee des Artikels war es, das Singleton Pattern 40 Millionen Mal aus vier Threads aufzurufen und die Ausführungszeit zu messen. Das Pattern wird erst bei Bedarf initialisiert. Der erste Aufruf, der es verwendet, initialisiert es. </div><div class="text">Ich habe das Singleton Pattern in vielen Variationen implementiert. Ich tat es mit einem <i>std::lock_guard </i>und der Funktion <i>std::call_once</i> in Kombination mit dem <i>std::once_flag</i>. Ich tat es mit einer statischen Variable. Ich wendete auch atomare Datentypen an und brach die Sequential-Konsistenz aus Performanzgründen.</div><div class="text">In diesem Artikel werde ich die einfachste und die anspruchsvollste Implementierung vorstellen.</div><div class="text">Die einfachste Implementierung ist das sogenannte Meyers' Singleton. Sie ist thread-sicher, da die C++-Laufzeit zusichert, dass Variablen mit Blockgültigkeit thread-sicher initialisiert werden. </div><div class="pre">// singletonMeyers.cpp<br><br>#include &lt;chrono&gt;<br>#include &lt;iostream&gt;<br>#include &lt;future&gt;<br><br>constexpr auto tenMill= 10000000;<br><br>class MySingleton{<br>public:<br>&nbsp; static MySingleton&amp; getInstance(){<br>&nbsp;&nbsp;&nbsp; static MySingleton instance;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // (1)<br>&nbsp;&nbsp;&nbsp; // volatile int dummy{};<br>&nbsp;&nbsp;&nbsp; return instance;<br>&nbsp; }<br>private:<br>&nbsp; MySingleton()= default;<br>&nbsp; ~MySingleton()= default;<br>&nbsp; MySingleton(const MySingleton&amp;)= delete;<br>&nbsp; MySingleton&amp; operator=(const MySingleton&amp;)= delete;<br><br>};<br><br>std::chrono::duration&lt;double&gt; getTime(){<br><br>&nbsp; auto begin= std::chrono::system_clock::now();<br>&nbsp; for ( size_t i= 0; i &lt;= tenMill; ++i){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MySingleton::getInstance();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // (2)<br>&nbsp; }<br>&nbsp; return std::chrono::system_clock::now() - begin;<br>&nbsp; <br>};<br><br>int main(){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp; auto fut1= std::async(std::launch::async,getTime);<br>&nbsp;&nbsp;&nbsp; auto fut2= std::async(std::launch::async,getTime);<br>&nbsp;&nbsp;&nbsp; auto fut3= std::async(std::launch::async,getTime);<br>&nbsp;&nbsp;&nbsp; auto fut4= std::async(std::launch::async,getTime);<br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp; auto total= fut1.get() + fut2.get() + fut3.get() + fut4.get();<br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp; std::cout &lt;&lt; total.count() &lt;&lt; std::endl;<br><br>}</div><div class="text">Zeile (1) nützt die Zusicherung aus, dass das Singleton thread-sicher initialisiert wird. Jeder der vier Threads in der <i>main</i>-Funktion ruft 10 Millionen Mal das Singleton in Zeile (2) auf. Das macht in Summe 40 Millionen Aufrufe. </div><div class="text">Das kann ich besser. In meiner zweiten Implementierung verwende ich atomare Datentypen, um das Singleton thread-sicher zu initialisieren. Meine Implementierung basiert auf dem berühmt-berüchtigten <a href="https://en.wikipedia.org/wiki/Double-checked_locking" alt="%7B%22ir_link%22%3A1%2C%22type%22%3A%22E%22%2C%22text%22%3A%22double-checked%20locking%20pattern%22%2C%22target%22%3A%22_blank%22%2C%22anchor%22%3A%22%22%2C%22href%22%3A%22https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FDouble-checked_locking%22%2C%22version%22%3A1%2C%22subject%22%3A%22%22%2C%22custom%22%3A%7B%7D%2C%22alias%22%3A%22%22%2C%22destination%22%3A%22https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FDouble-checked_locking%22%2C%22user_params%22%3A%22%22%7D" title="Link auf https://en.wikipedia.org/wiki/Double-checked_locking">double-checked locking pattern</a>. Der Einfachheit halber stelle ich nur die Implementierung der Klasse <i>MySingleton </i>vor. <br></div><div class="pre">class MySingleton{<br>public:<br>&nbsp; static MySingleton* getInstance(){<br>&nbsp;&nbsp;&nbsp; MySingleton* sin= instance.load(std::memory_order_acquire);<br>&nbsp;&nbsp;&nbsp; if ( !sin ){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; std::lock_guard&lt;std::mutex&gt; myLock(myMutex);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sin= instance.load(std::memory_order_relaxed);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if( !sin ){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sin= new MySingleton();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; instance.store(sin,std::memory_order_release);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp; // volatile int dummy{};<br>&nbsp;&nbsp;&nbsp; return sin;<br>&nbsp; }<br>private:<br>&nbsp; MySingleton()= default;<br>&nbsp; ~MySingleton()= default;<br>&nbsp; MySingleton(const MySingleton&amp;)= delete;<br>&nbsp; MySingleton&amp; operator=(const MySingleton&amp;)= delete;<br><br>&nbsp; static std::atomic&lt;MySingleton*&gt; instance;<br>&nbsp; static std::mutex myMutex;<br>};<br><br><br>std::atomic&lt;MySingleton*&gt; MySingleton::instance;<br>std::mutex MySingleton::myMutex;</div><div class="text">Es ist keine Geheimnis mehr: <a alt="%7B%22ir_link%22%3A1%2C%22type%22%3A%22E%22%2C%22target%22%3A%22_blank%22%2C%22text%22%3A%22double-checked%20locking%20pattern%20is%20broken%22%2C%22anchor%22%3A%22%22%2C%22href%22%3A%22http%3A%2F%2Fwiki.c2.com%2F%3FDoubleCheckedLockingIsBroken%22%2C%22version%22%3A1%2C%22alias%22%3A%22%22%2C%22custom%22%3A%7B%7D%2C%22subject%22%3A%22%22%2C%22destination%22%3A%22http%3A%2F%2Fwiki.c2.com%2F%3FDoubleCheckedLockingIsBroken%22%2C%22user_params%22%3A%22%22%7D" href="http://wiki.c2.com/?DoubleCheckedLockingIsBroken" title="Link auf http://wiki.c2.com/?DoubleCheckedLockingIsBroken">double-checked locking pattern is broken</a>. Das gilt natürlich nicht für meine Implementierung. Falls du mir nicht glaubst, beweise mir das Gegenteil. Zuerst musst du dich in diesem Fall mit dem Speichermodell auseinandersetzen, danach die Acquire-Release-Semantik studieren und zuallerletzt dir Gedanken dazu machen, welche Synchronisations- und Ordnungsbedingungen diese in diesem konkreten Fall garantiert. Das ist keine einfache Aufabe. Was macht man nicht alles für die Performanz.</div><div class="text">Ich habe die Regel Per.6 vergessen. Hier sind die Performanzahlen zum Meyers' Singleton auf Linux. Ich habe das Programm mit maximaler Optimierung übersetzt. Die Zahlen auf Windows befinden sich in einer ähnlichen Größenordnung.</div><div class="text"><img class="rteInlinetag" src="https://heise-cms.de/thumbs//TN_150613476_7179f8be5e.png" title="<ir_inline itemname=bilder_mvp_bild_var2:4 type=2>" style="max-height: 25px; max-width: 25px;"></div><div class="text">Jetzt bin ich neugierig. Was sprechen die Performanzzahlen zu meinem hochoptimierten Code? Eine eindeutige Sprache:</div><div class="text"><img class="rteInlinetag" src="https://heise-cms.de/thumbs//TN_150613482_148891bf85.png" title="<ir_inline itemname=bilder_mvp_bild_var2:6 type=2>" style="max-height: 25px; max-width: 25px;">&nbsp;</div><div class="text">50 Prozent langsamer, und wir wissen nicht einmal, ob die Implementierung korrekt ist. Nur zur Sicherheit: Die Implementierung ist korrekt.</div><div class="text">In der Tat war das Meyers' Singleton die einfachste und performanteste Varianten ein Singleton Pattern thread-sicher umzusetzen. Weitere Details zu dem Singleton Pattern gibt es hier: "<a alt="%7B%22anchor%22%3A%22%22%2C%22text%22%3A%22Thread-sicheres%20Initialisieren%20eines%20Singleton%22%2C%22target%22%3A%22_blank%22%2C%22ir_link%22%3A1%2C%22type%22%3A%22E%22%2C%22destination%22%3A%22https%3A%2F%2Fwww.grimm-jaud.de%2Findex.php%2Fblog%2Fthreadsicheres-initialisieren-eines-singletons%22%2C%22user_params%22%3A%22%22%2C%22href%22%3A%22https%3A%2F%2Fwww.grimm-jaud.de%2Findex.php%2Fblog%2Fthreadsicheres-initialisieren-eines-singletons%22%2C%22custom%22%3A%7B%7D%2C%22alias%22%3A%22%22%2C%22subject%22%3A%22%22%2C%22version%22%3A1%7D" href="https://www.grimm-jaud.de/index.php/blog/threadsicheres-initialisieren-eines-singletons" title="Link auf https://www.grimm-jaud.de/index.php/blog/threadsicheres-initialisieren-eines-singletons">Thread-sicheres Initialisieren eines Singleton</a>".</div><div class="ztitel">Wie geht's weiter?</div><div class="text">Es gibt noch mehr als 10 Regeln zur Performanz in den Guidelines. Obwohl es relativ anspruchsvoll ist, über diese sehr allgemeinen Regeln zu schreiben, habe ich ein paar Ideen für den nächsten Artikel im Kopf.</div><div class="ztitel">Weitere Informationen</div><div class="text"><ul><li> <b>Wahl des nächsten PDF-Päckchen</b>. Auf meinem deutschen Blog und meinem englischen Blog findet gerade die Wahl zum nächsten PDF-Päckchen statt. Hier sind die Links zur Wahl:</li><ul><li>Deutscher Blog: <a title="Link auf https://www.grimm-jaud.de/index.php/blog/welches-pdf-paeckchen-soll-ich-zusammenstellen-mache-dein-kreuz-3" alt="%7B%22text%22%3A%22Welches%20PDF-P%C3%A4ckchen%20soll%20ich%20zusammenstellen%3F%20Mache%20dein%20Kreuz%21%22%2C%22target%22%3A%22_blank%22%2C%22anchor%22%3A%22%22%2C%22type%22%3A%22E%22%2C%22ir_link%22%3A1%2C%22user_params%22%3A%22%22%2C%22destination%22%3A%22https%3A%2F%2Fwww.grimm-jaud.de%2Findex.php%2Fblog%2Fwelches-pdf-paeckchen-soll-ich-zusammenstellen-mache-dein-kreuz-3%22%2C%22version%22%3A1%2C%22custom%22%3A%7B%7D%2C%22subject%22%3A%22%22%2C%22alias%22%3A%22%22%2C%22href%22%3A%22https%3A%2F%2Fwww.grimm-jaud.de%2Findex.php%2Fblog%2Fwelches-pdf-paeckchen-soll-ich-zusammenstellen-mache-dein-kreuz-3%22%7D" href="https://www.grimm-jaud.de/index.php/blog/welches-pdf-paeckchen-soll-ich-zusammenstellen-mache-dein-kreuz-3">Welches PDF-Päckchen soll ich zusammenstellen? Mache dein Kreuz!</a> <br></li><li>Englischer Blog: <a href="http://www.modernescpp.com/index.php/which-pdf-bundle-should-i-provide-make-your-choice-2" alt="%7B%22href%22%3A%22http%3A%2F%2Fwww.modernescpp.com%2Findex.php%2Fwhich-pdf-bundle-should-i-provide-make-your-choice-2%22%2C%22alias%22%3A%22%22%2C%22subject%22%3A%22%22%2C%22custom%22%3A%7B%7D%2C%22version%22%3A1%2C%22destination%22%3A%22http%3A%2F%2Fwww.modernescpp.com%2Findex.php%2Fwhich-pdf-bundle-should-i-provide-make-your-choice-2%22%2C%22user_params%22%3A%22%22%2C%22ir_link%22%3A1%2C%22type%22%3A%22E%22%2C%22anchor%22%3A%22%22%2C%22text%22%3A%22Which%20PDF%20bundle%20should%20I%20provide%3F%20Make%20your%20choice%21%22%2C%22target%22%3A%22_blank%22%7D" title="Link auf http://www.modernescpp.com/index.php/which-pdf-bundle-should-i-provide-make-your-choice-2">Which PDF bundle should I provide? Make your choice!</a> </li></ul></ul></div><div class="text"><br></div>